<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dessiner une œuvre</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      margin: 0; padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    canvas {
      border: 2px solid #000;
      margin-top: 1em;
      touch-action: none;
    }
    .controls {
      margin-top: 1em;
      display: flex;
      flex-direction: column;
      gap: 0.5em;
      width: 100%;
      max-width: 400px;
    }
    label {
      font-weight: bold;
    }
    button {
      padding: 0.5em;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <h1>🖌️ Dessine ton œuvre !</h1>

  <div class="controls">
    <label for="color">🎨 Couleur :</label>
    <input type="color" id="color" value="#000000">

    <label for="size">🔧 Taille du pinceau :</label>
    <input type="range" id="size" min="1" max="20" value="3">

    <label for="title">📝 Titre de ton œuvre :</label>
    <input type="text" id="title" placeholder="Titre...">

    <button id="submit">✅ Valider et envoyer</button>
  </div>

  <canvas id="drawing-canvas" width="400" height="400"></canvas>

  <script>
    const canvas = document.getElementById('drawing-canvas');
    const ctx = canvas.getContext('2d');
    const colorPicker = document.getElementById('color');
    const sizePicker = document.getElementById('size');
    const titleInput = document.getElementById('title');
    const submitButton = document.getElementById('submit');

    let drawing = false;

    ctx.lineWidth = sizePicker.value;
    ctx.strokeStyle = colorPicker.value;
    ctx.lineCap = 'round';

    function getXY(e) {
      const rect = canvas.getBoundingClientRect();
      if (e.touches) {
        return {
          x: e.touches[0].clientX - rect.left,
          y: e.touches[0].clientY - rect.top
        };
      } else {
        return {
          x: e.offsetX,
          y: e.offsetY
        };
      }
    }

    function startDraw(e) {
      drawing = true;
      const { x, y } = getXY(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    function draw(e) {
      if (!drawing) return;
      const { x, y } = getXY(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    }

    function stopDraw() {
      drawing = false;
      ctx.closePath();
    }

    // Events
    canvas.addEventListener('mousedown', startDraw);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseup', stopDraw);
    canvas.addEventListener('mouseout', stopDraw);

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      startDraw(e);
    });
    canvas.addEventListener('touchmove', (e) => {
      e.preventDefault();
      draw(e);
    });
    canvas.addEventListener('touchend', stopDraw);
    canvas.addEventListener('touchcancel', stopDraw);

    // Update brush
    colorPicker.addEventListener('change', () => {
      ctx.strokeStyle = colorPicker.value;
    });

    sizePicker.addEventListener('input', () => {
      ctx.lineWidth = sizePicker.value;
    });

    // Submit
    submitButton.addEventListener('click', async () => {
      const title = titleInput.value.trim();
      if (!title) return alert("Ajoute un titre à ton œuvre !");
      
      const image = canvas.toDataURL('image/png');
      
      try {
        const res = await fetch('/submit-drawing', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, image })
        });
        const data = await res.json();
        alert(data.message || "✅ Envoyé !");
        // Reset canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        titleInput.value = '';
      } catch (err) {
        alert('❌ Erreur lors de l’envoi.');
      }
    });
  </script>

</body>
</html>
